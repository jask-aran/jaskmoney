# Jaskmoney v0.3 Spec & Implementation Plan

## Context

v0.2 delivered a solid foundation: 3-tab TUI, SQLite persistence, CSV import, flat categories with rules, Catppuccin theme, and good test coverage (~7,200 LOC across 15 files). v0.3 builds on this with accounts, tags, a command system, bulk operations, and dashboard refinements. The goal is to transform jaskmoney from a single-wallet categorizer into a multi-account finance tracker with rich interaction patterns.

## Pre-Work: Split model.go

`model.go` is 1,775 lines and will grow significantly. Before feature work, split it:

- **model.go** — struct definitions, `Init()`, `View()`, message types (~300 lines)
- **update_main.go** — `Update()` dispatch, dashboard/transactions key handlers
- **update_settings.go** — settings tab key handlers (categories, rules, DB/import)
- **filter.go** — `filteredRows()`, all match functions, sort logic
- **layout.go** — `composeOverlay()`, `footerBindings()`, dimension helpers

No behavior changes. All tests must pass after split.

---

## Phase 1: Keybinding Registry (v0.21)

**Goal:** Replace the ad-hoc `keyMap` struct with a centralized registry that the footer, command palette, and help all consume.

**New file: `keys.go`**

```go
type Action string // e.g. "quit", "next_tab", "search", "select", ...

type Binding struct {
    Action Action
    Keys   []string   // "q", "ctrl+c"
    Help   string     // short description
    Scopes []string   // "global", "transactions", "settings", "dashboard", "modal"
}

type KeyRegistry struct { ... }
func NewKeyRegistry() *KeyRegistry
func (r *KeyRegistry) Register(b Binding)
func (r *KeyRegistry) BindingsForScope(scope string) []Binding
func (r *KeyRegistry) Lookup(key, scope string) *Binding
func (r *KeyRegistry) HelpBindings(scope string) []key.Binding  // for footer
```

**Changes:**
- `model.go`: Replace `keys keyMap` with `keys *KeyRegistry`
- `layout.go`: `footerBindings()` reads from registry instead of hand-built slices
- `render.go`: `renderFooter` unchanged (still takes `[]key.Binding`)

**Tests:** `keys_test.go` — scope lookup, no duplicate bindings in same scope, help generation.

**Acceptance:**
- All existing keybindings work identically
- Footer help text generated from registry
- No hard-coded binding lists in footer functions

---

## Phase 2: Dashboard Timeframe (v0.22)

**Goal:** Replace the `d`-key date cycling (currently on transactions tab) with visual preset chips on the dashboard only. Transactions tab defaults to all-time.

**New model fields:**
- `dashTimeframe int` (thisMonth/lastMonth/1M/2M/3M/6M/YTD/1Y/custom)
- `dashTimeframeFocus bool`
- `dashCustomStart`, `dashCustomEnd`, `dashCustomInput string`

**Render:** Row of chips at top of dashboard: `[This Month] [Last Month] [1M] [2M] [3M] [6M] [YTD] [1Y] [Custom]`. Active chip highlighted with `colorAccent`. Focused chip has cursor.

**Interaction:** Press `d` on dashboard to focus chips. `h`/`l` to navigate. `Enter` to select. Custom opens date input (two fields: start, end). `Esc` cancels.

**Removal:** Remove `filterDateRange` field and `dateRangeAll/ThisMonth/etc` constants from transactions tab. The `d` binding on transactions is freed.

**Filter changes:** New `filterByTimeframe()` function applied in dashboard view only. `filteredRows()` in transactions loses the date range parameter.

**Tests:** Timeframe filtering logic, chip rendering, transactions tab has no date filter.

**Acceptance:**
- Dashboard shows timeframe chips, default "This Month"
- h/l navigation on chips when focused
- Custom opens date input
- Transactions tab shows all-time, sorted by date desc

### Phase 2 Completion Notes (v0.22)

Status: **Complete**

Implemented additions:
- Added rolling presets `1M` and `2M` in addition to the original Phase 2 preset set.
- Added adaptive spending tracker axis behavior so x-axis/gridline spacing updates with selected timeframe.
- Updated y-axis tick labels to compact formatting (`k`/`m`) to avoid clipping on larger values.

Acceptance check:
- [x] Dashboard shows timeframe chips, default `"This Month"`
- [x] `h/l` navigation on chips when focused
- [x] Custom opens date input (start + end, `YYYY-MM-DD`)
- [x] Transactions tab shows all-time (no dashboard date filter applied there), sorted by date desc

---

## Phase 3: Bulk Selection (v0.23)

**Goal:** Enable multi-row selection on the transactions tab for upcoming bulk actions.

**New model field:** `selectedRows map[int]bool` (keyed by transaction ID)

**Interaction:**
- `Space` — toggle selection on cursor row
- `Shift+Up/Down` — create and adjust highlighted range from current cursor anchor
- `Space` (while range is highlighted) — toggle whole highlighted range (select all or deselect all)
- `Esc` — clears highlighted range first, then clears all selected rows

**Key detail:** Selection is by transaction ID, not index, so it survives re-filtering/re-sorting.

**Render:** Full-line themed row highlighting for cursor, highlighted range, selected rows, and overlap states. Selection count shown in title: `Transactions (3 selected)`.

**Tests:** Toggle, shift-move highlight range, range toggle, clear precedence, persistence across filter/sort changes.

**Acceptance:**
- Space toggles, Shift+Up/Down highlights ranges, Space toggles highlighted range, Esc clears in priority order
- Visual indicator uses line highlighting (theme-based), not row prefix markers
- Selection survives filter/sort changes

### Phase 3 Completion Notes (v0.23)

Status: **Accepted**

Implemented additions:
- Added ID-based selection state and shift-driven range highlight state on transactions view.
- Added range toggle behavior: pressing `Space` with an active highlighted range toggles the full range selection.
- Added Esc priority behavior: clear range highlight, then clear selection, then clear search.
- Reworked row rendering to full-width, theme-consistent line highlighting for cursor, highlighted range, selected rows, and overlap states.

Acceptance check:
- [x] Space toggles row selection
- [x] Shift+Up/Down highlights a range from cursor anchor
- [x] Space toggles all rows in active highlighted range
- [x] Esc clears highlight first, then selected rows, then search
- [x] Selection survives filter/sort changes
- [x] Full-width line highlighting is used instead of prefix markers

---

## Phase 4: Fuzzy Picker Component (v0.24)

**Goal:** Build a reusable fuzzy picker that will power the category picker, tag picker, and command palette.

**New file: `picker.go`**

```go
type pickerItem struct {
    ID      int
    Label   string
    Color   string    // optional colored indicator
    Section string    // grouping header (e.g. "Scoped", "Global")
    Meta    string    // dimmed secondary text
}

type pickerState struct {
    items       []pickerItem
    filtered    []pickerItem
    query       string
    cursor      int
    selected    map[int]bool  // for multi-select
    multiSelect bool
    title       string
    createLabel string        // "Create [query]" shown when no match
}
```

Functions: `newPicker()`, `SetQuery()`, `CursorUp/Down()`, `Toggle()`, `Selected()`, `HandleKey()`.
Rendering: `renderPicker()` — search bar at top, grouped/filtered results below, create option at bottom.
Fuzzy matching: subsequence match with prefix bonus + consecutive bonus.

**Tests:** `picker_test.go` — fuzzy match scoring, filtering, multi-select toggle, create option visibility.

**Acceptance:**
- Picker filters items by fuzzy query
- Sections group items visually
- Create option appears when no exact match
- Multi-select mode works with toggle

---

## Phase 5: Quick Category Picker + Quick Tag Setup (v0.25)

**Goal:** Press `c` to quickly categorize transactions without opening the full detail modal. Lay groundwork for tags.

**Interaction:**
- `c` on transactions tab opens picker as overlay
- If rows are selected (Phase 3), applies to all selected; otherwise applies to cursor row
- Fuzzy search to narrow categories
- `Enter` selects and saves, `Esc` cancels

**Model fields:** `catPicker *pickerState`, `catPickerFor []int` (transaction IDs)

**Tests:** Quick categorize single row, bulk categorize selected rows.

**Acceptance:**
- `c` opens inline fuzzy category picker
- Works for single and bulk selection
- Saved to DB immediately

### Phase 5 Completion Notes (v0.25)

Status: **Accepted**

Implemented additions:
- Added quick category picker overlay on transactions via `c`, powered by the shared fuzzy `pickerState`.
- Added bulk target resolution: apply to selected transaction IDs when present, otherwise apply to the cursor row.
- Added inline category create from picker (`Create "<query>"`) and immediate apply to target transactions.
- Added atomic bulk DB update helper for multi-transaction category assignment.
- Added picker-specific footer bindings and upgraded picker styling (transaction-style line highlighting + category-colored labels + dark search line).

Acceptance check:
- [x] `c` opens inline fuzzy category picker
- [x] Works for single and bulk selection
- [x] Saved to DB immediately

---

## Phase 6: Accounts System (v0.26)

**Goal:** Multi-account support with an account switcher, import-time assignment, and credit account sign-flipping.

### Schema v3 Migration

Add to existing schema:

```sql
CREATE TABLE accounts (
    id         INTEGER PRIMARY KEY AUTOINCREMENT,
    name       TEXT NOT NULL UNIQUE,
    type       TEXT NOT NULL CHECK(type IN ('debit','credit')) DEFAULT 'debit',
    sort_order INTEGER NOT NULL DEFAULT 0,
    is_active  INTEGER NOT NULL DEFAULT 1
);

CREATE TABLE account_selection (
    account_id INTEGER NOT NULL REFERENCES accounts(id) ON DELETE CASCADE
);

ALTER TABLE transactions ADD COLUMN account_id INTEGER REFERENCES accounts(id);
```

Migration: v2 -> v3. Existing transactions get `account_id = NULL`.

### New structs

```go
type account struct {
    id       int
    name     string
    acctType string  // "debit" or "credit"
    sortOrder int
    isActive bool
}
```

Transaction struct gains: `accountID *int`, `accountName string`, `accountType string` (denormalized from JOIN).

### Config change

`csvFormat` gains `Account string` field. TOML:
```toml
[[format]]
name = "ANZ"
account = "ANZ Savings"
```

### Import flow changes

1. After format detection, look up `format.Account` in accounts table
2. If not found or empty, show account picker modal (or create new)
3. User can override the auto-detected account
4. Credit accounts: negate amount on import (`amount = -amount`)
5. `importCSV()` receives `accountID` parameter, sets on INSERT

### Account switcher modal

- Global shortcut (registered in KeyRegistry) opens modal from anywhere
- Multi-select: toggle accounts on/off with Space
- `Enter` confirms, saves to `account_selection` table (persisted)
- `Esc` cancels
- Empty selection = all accounts (default)

### Filter pipeline

`filteredRows()` gains `accountFilter map[int]bool` parameter. `matchesAccountFilter()` added. Applied in both dashboard and transactions views.

### Settings

New section "Accounts" — CRUD for accounts (name, type). Same patterns as categories.

### Render

- Transaction table shows account column when multiple accounts have data
- Dashboard summaries respect account filter
- Account indicator in header bar: "ANZ Savings" or "All Accounts"

**Tests:**
- `db_test.go`: Migration v2->v3, account CRUD, selection persistence
- `ingest_test.go`: Account assignment, credit sign flip
- `model_test.go`: Switcher toggle, filter integration

**Acceptance:**
- Accounts CRUD in Settings
- Import auto-detects from config, manual override available
- Credit accounts flip signs
- Switcher modal filters both views
- Selection persists across restarts

---

## Phase 7: Tags System (v0.27)

**Goal:** Freeform tags alongside categories. Tags can be scoped to a category or global.

### Schema additions

```sql
CREATE TABLE tags (
    id          INTEGER PRIMARY KEY AUTOINCREMENT,
    name        TEXT NOT NULL UNIQUE,
    color       TEXT NOT NULL DEFAULT '#94e2d5',
    category_id INTEGER REFERENCES categories(id) ON DELETE SET NULL,
    sort_order  INTEGER NOT NULL DEFAULT 0
);

CREATE TABLE transaction_tags (
    transaction_id INTEGER NOT NULL REFERENCES transactions(id) ON DELETE CASCADE,
    tag_id         INTEGER NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
    PRIMARY KEY (transaction_id, tag_id)
);

CREATE TABLE tag_rules (
    id       INTEGER PRIMARY KEY AUTOINCREMENT,
    pattern  TEXT NOT NULL UNIQUE,
    tag_id   INTEGER NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
    priority INTEGER NOT NULL DEFAULT 0
);
```

- `tags.category_id = NULL` means global
- `tags.category_id = N` means scoped to that category

### Tag picker

Press `t` on transactions tab. Uses the shared `pickerState` (Phase 4):
- **Scoped tags** (matching transaction's current category) appear first under section header
- **Global tags** appear next
- Fuzzy search filters all
- "Create [typed text]" appears as last option if no exact match — creates a global tag inline
- Tag scope is managed in Settings, not during inline creation
- Multi-select mode: toggle tags on/off

### Bulk tagging

Select rows (Phase 3), press `t`. Tag picker opens. Tags applied to all selected transactions.

### Auto-tag rules

Same pattern as category rules: pattern + tag. Applied on import alongside category rules.

### Settings

New section "Tags" — CRUD (name, color, scope via category picker). Tag Rules section: pattern + tag picker.

### Model changes

```go
tags     []tag
tagRules []tagRule
txnTags  map[int][]tag  // transaction ID -> tags
tagPicker    *pickerState
tagPickerFor []int
```

### Render

- Transaction table shows small colored tag pills after category
- Detail modal shows tags
- Search matches tag names

**Tests:**
- `db_test.go`: Tag CRUD, scoped queries, junction table, tag rules
- `picker_test.go`: Scoped tag ordering
- `model_test.go`: Tag picker flow, bulk tagging

**Acceptance:**
- Tags CRUD in Settings (global + scoped)
- `t` opens fuzzy tag picker with scoped tags first
- Inline create works
- Bulk tagging works
- Tag rules auto-apply on import
- Tags display in table and detail

---

## Phase 8: Command Palette & Command Mode (v0.28)

**Goal:** Two interfaces (modal palette + footer command mode) sharing one command registry.

### New file: `commands.go`

```go
type Command struct {
    ID          string
    Label       string
    Description string
    Action      Action
    Category    string  // "Navigation", "Actions", "Settings"
    Execute     func(m *model) tea.Cmd
}

type CommandRegistry struct { ... }
func NewCommandRegistry(keys *KeyRegistry) *CommandRegistry
func (r *CommandRegistry) All() []Command
func (r *CommandRegistry) Search(query string) []Command
```

Commands registered: go:dashboard, go:transactions, go:settings, import, apply-rules, apply-tag-rules, clear-filters, clear-search, accounts, etc.

### Command palette (Ctrl+K)

- Modal overlay with search bar at top, filtered suggestions below
- Uses `pickerState` with items from `CommandRegistry`
- Enter executes, Esc closes

### Command mode (:)

- `:` activates command mode
- Footer line becomes input field
- Suggestions appear as floating list above footer
- Enter executes, Esc cancels

### Config

User preference stored (palette vs colon default). Both always available.

**Tests:**
- `commands_test.go`: Registry search, fuzzy matching
- `model_test.go`: Palette open/close, command execution, colon mode

**Acceptance:**
- Ctrl+K opens palette with fuzzy search
- `:` opens command mode in footer
- Commands execute correctly
- Both share same registry

---

## Phase 9: UX Polish (v0.29 -> v0.3)

1. **Number keys for tabs:** `1` = Dashboard, `2` = Transactions, `3` = Settings
2. **Consistent modal dismiss:** Esc always closes topmost modal
3. **Footer consistency:** All views use KeyRegistry
4. **Account indicator in header bar**
5. **Search matches tag names** (already scoped in Phase 7)
6. **Remove Analytics stub tab** (was never implemented; replaced by enhanced dashboard)

**Acceptance:**
- Number keys navigate tabs
- Consistent Esc behavior across all modals
- All footers auto-generated from registry
- Clean, polished v0.3 release

---

## Phase Summary & Dependencies

```
Pre-work: Split model.go
    |
Phase 1: Key Registry (v0.21)
    |
    +-- Phase 2: Dashboard Timeframe (v0.22)
    |
    +-- Phase 3: Bulk Selection (v0.23)
    |
    +-- Phase 4: Fuzzy Picker (v0.24)
            |
            +-- Phase 5: Quick Category Picker (v0.25)
            |
            +-- Phase 8: Command Palette (v0.28) [also needs Phase 1]
    |
Phase 6: Accounts (v0.26) [needs Phases 1-4]
    |
Phase 7: Tags (v0.27) [needs Phases 4, 5, 6]
    |
Phase 8: Command Palette (v0.28) [needs Phases 1, 4]
    |
Phase 9: Polish (v0.29 -> v0.3) [needs all above]
```

Phases 2, 3, 4 can be built in parallel after Phase 1.

---

## Verification

After each phase:
1. `go build .` succeeds
2. `go vet ./...` clean
3. `go test ./...` all pass
4. Manual smoke test: launch app, exercise the new feature
5. Tag the sub-release (e.g. `git tag v0.21`)

Final v0.3:
- Full end-to-end test: create account -> import CSV -> auto-assign account -> auto-categorize -> tag transactions -> filter by account -> filter by timeframe on dashboard -> use command palette to navigate -> bulk select and categorize
- All 9 phases complete with tests passing
