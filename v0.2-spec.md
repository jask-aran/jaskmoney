# Jaskmoney v0.2 Specification

## Vision

Transform jaskmoney from a basic bank statement viewer into a personal finance tracker with transaction categorization, analytics, and a polished Catppuccin Mocha-themed TUI. The app should feel like a modern terminal tool in the vein of Claude Code, OpenCode, or NvChad — clean panels, muted pastels, thoughtful whitespace, and fluid navigation.

## Architecture Overview

### Current State (v0.1)

- Single-screen dashboard with transaction table and basic overview (net value, net debits)
- ANZ-only CSV import via popup modal
- No categories, no filtering, no search, no analytics
- Zero test coverage
- Flat `package main` structure with 6 source files (~990 LOC)

### Target State (v0.2)

- Four-tab multi-screen layout: **Dashboard**, **Transactions**, **Analytics** (stub), **Settings**
- Transaction categorization with manual assignment + rule-based auto-categorization
- Full filtering, sorting, and search on transactions
- Catppuccin Mocha color theme throughout
- Config-driven extensible CSV format system (TOML)
- Duplicate detection on import
- Comprehensive test suite alongside implementation
- `asciigraph` library for spending trend visualization

---

## Catppuccin Mocha Theme Specification

All colors use true-color hex values via lipgloss. Replace all current ANSI 256-color references.

### Palette Reference

| Role | Color Name | Hex | Usage |
|------|-----------|------|-------|
| Background | Base | `#1e1e2e` | Main background |
| Secondary BG | Mantle | `#181825` | Header/footer bars, status bar |
| Tertiary BG | Crust | `#11111b` | Deepest background layer |
| Surface (low) | Surface 0 | `#313244` | Panel backgrounds, inactive borders |
| Surface (mid) | Surface 1 | `#45475a` | Selected row background, subtle borders |
| Surface (high) | Surface 2 | `#585b70` | Hover states, secondary selections |
| Overlay (low) | Overlay 0 | `#6c7086` | Inactive borders, disabled text |
| Overlay (mid) | Overlay 1 | `#7f849c` | Subtle text, line numbers |
| Overlay (high) | Overlay 2 | `#9399b2` | Comments, delimiters |
| Subtext 0 | Subtext 0 | `#a6adc8` | Labels, secondary text |
| Subtext 1 | Subtext 1 | `#bac2de` | Sub-headlines |
| Text | Text | `#cdd6f4` | Primary body text |
| Accent (primary) | Lavender | `#b4befe` | Active tab indicator, active borders, selection highlight |
| Accent (secondary) | Mauve | `#cba6f7` | App branding, section titles |
| Success / Income | Green | `#a6e3a1` | Credit amounts, positive values |
| Error / Expense | Red | `#f38ba8` | Debit amounts, errors, destructive actions |
| Warning | Yellow | `#f9e2af` | Duplicate warnings, caution states |
| Info | Teal | `#94e2d5` | Info messages, tags |
| Links / Tags | Blue | `#89b4fa` | Category tags default |
| Highlight | Peach | `#fab387` | Numbers, amounts, counts |
| Pink | Pink | `#f5c2e7` | Category color option |
| Sky | Sky | `#89dceb` | Category color option |
| Sapphire | Sapphire | `#74c7ec` | Category color option |
| Flamingo | Flamingo | `#f2cdcd` | Category color option |
| Rosewater | Rosewater | `#f5e0dc` | Cursor highlight |
| Maroon | Maroon | `#eba0ac` | Category color option |

### Style Mapping

| UI Element | FG | BG | Properties |
|-----------|-----|-----|-----------|
| App name ("Jaskmoney") | Mauve | Mantle | Bold |
| Header bar | Text | Mantle | Padding(0,2) |
| Active tab label | Lavender | Surface 0 | Bold |
| Inactive tab label | Overlay 1 | Mantle | -- |
| Tab separator | Overlay 0 | Mantle | -- |
| Section title | Mauve | -- | Bold |
| Section border (active) | Lavender | -- | Rounded |
| Section border (inactive) | Surface 1 | -- | Rounded |
| Table header row | Subtext 0 | -- | Bold |
| Table body text | Text | -- | -- |
| Selected row | Text | Surface 1 | -- |
| Cursor indicator | Lavender | -- | Bold |
| Credit amount | Green | -- | -- |
| Debit amount | Red | -- | -- |
| Category tag | (per-category) | (per-category, dimmed) | Rounded padding(0,1) |
| Footer bar | Subtext 0 | Mantle | Padding(0,2) |
| Footer key hints | Lavender | -- | Bold |
| Footer descriptions | Subtext 0 | -- | -- |
| Status bar | Subtext 1 | Surface 0 | Padding(0,2) |
| Status error | Red | Surface 0 | -- |
| Status success | Green | Surface 0 | -- |
| Modal overlay BG | Text | Surface 0 | Rounded border |
| Modal border | Lavender | -- | Rounded |
| Search input | Text | Surface 0 | -- |
| Search prompt "/" | Lavender | -- | Bold |
| Scroll indicator | Overlay 1 | -- | -- |

### Category Color Assignments

Each default category gets a unique Catppuccin accent color:

| Category | Color | Hex |
|----------|-------|-----|
| Income | Green | `#a6e3a1` |
| Groceries | Teal | `#94e2d5` |
| Dining & Drinks | Peach | `#fab387` |
| Transport | Blue | `#89b4fa` |
| Bills & Utilities | Mauve | `#cba6f7` |
| Entertainment | Pink | `#f5c2e7` |
| Shopping | Flamingo | `#f2cdcd` |
| Health | Sapphire | `#74c7ec` |
| Transfers | Lavender | `#b4befe` |
| Uncategorised | Overlay 1 | `#7f849c` |

---

## Screen Specifications

### Global Layout

```
+---------------------------------------------------------+
|  Jaskmoney     Dashboard | Transactions | Analytics | Settings  |  <- Header bar (Mantle BG)
+---------------------------------------------------------+
|                                                         |
|                   [Screen Content]                       |  <- Base BG
|                                                         |
+---------------------------------------------------------+
|  Status: Imported 113 transactions from ANZ.csv         |  <- Status bar (Surface 0 BG)
+---------------------------------------------------------+
|  tab next  shift+tab prev  / search  q quit             |  <- Footer (Mantle BG)
+---------------------------------------------------------+
```

**Navigation:** `Tab` / `Shift+Tab` to cycle tabs. Footer key hints update per-screen.

### Screen 1: Dashboard

The dashboard provides an at-a-glance financial overview.

**Layout:**

```
+- Overview --------------------------------------------------+
|                                                              |
|   Balance         $1,234.56     Transactions    113          |
|   Income          $5,678.90     Categories       8           |
|   Expenses       -$4,444.34     Date Range   Jan-Mar         |
|                                                              |
+- Spending by Category --------------------------------------+
|                                                              |
|   Groceries     ████████████████░░░░  42%   $1,867           |
|   Dining        ████████░░░░░░░░░░░░  21%     $934           |
|   Transport     █████░░░░░░░░░░░░░░░  13%     $578           |
|   Bills         ████░░░░░░░░░░░░░░░░  10%     $445           |
|   Entertainment ██░░░░░░░░░░░░░░░░░░   5%     $222           |
|   Other         ██░░░░░░░░░░░░░░░░░░   9%     $398           |
|                                                              |
+- Monthly Trend (3 months) ----------------------------------+
|                                                              |
|   [asciigraph line chart: income vs expenses]                |
|                                                              |
+--------------------------------------------------------------+
```

**Widgets:**

1. **Summary Cards** — Balance (income - expenses), total income, total expenses, transaction count, active category count, date range of data
2. **Spending by Category** — Horizontal bar chart with category color, percentage, and dollar amount. Top 6 categories + "Other" bucket. Each bar uses the category's assigned color.
3. **Monthly Trend** — `asciigraph.PlotMany` with two series (income green, expenses red) over last 3 months. Shows monthly aggregated totals.

### Screen 2: Transactions

Full transaction management with search, filter, sort, and inline category editing.

**Layout:**

```
+- Transactions (113) --- sorted by: date desc ---------------+
|  / Search: ___________________________________               |
|                                                              |
|  Date         Amount    Category        Description          |
|  ---------------------------------------------------------- |
|  2026-02-03   -$20.00   Dining & Dr...  DAN MURPHY'S/58..   |
|  2026-02-03    $39.71   Income          PAYMENT THANK Y..   |
|> 2026-02-03  $203.92   Groceries       WOOLWORTHS 1234..   |
|  2026-02-02   -$15.00   Transport       MYKI AUTO TOP U..   |
|  ...                                                         |
|                                                              |
|  -- showing 1-25 of 113 --                                   |
+--------------------------------------------------------------+
```

**Features:**

- **Search** (`/`): Vim-style search — press `/`, type query, filters description in real-time, `Esc` to clear
- **Sort**: `s` to cycle sort column (date, amount, category, description), `S` (shift+s) to reverse direction
- **Filter by category**: `f` to open category filter list, select to toggle, `Esc` to close
- **Filter by date range**: `d` to set date range (preset options: this month, last month, last 3 months, all time)
- **Edit transaction**: `Enter` on selected row opens detail modal
- **Scroll indicator**: Shows position (e.g., "showing 1-25 of 113")

**Transaction Detail Modal:**

```
+- Transaction Detail ----------------------------+
|                                                  |
|  Date:         2026-02-03                        |
|  Amount:       -$20.00                           |
|  Description:  DAN MURPHY'S/580 MELBOURN SP...   |
|                                                  |
|  Category:     [Dining & Drinks    v]            |
|  Notes:        [_______________________]         |
|                                                  |
|  enter save   esc cancel                         |
+--------------------------------------------------+
```

- Category field is a selectable dropdown (navigate with j/k, Enter to confirm)
- Notes field is a text input (bubbles/textinput)
- `Enter` saves, `Esc` cancels

### Screen 3: Analytics (Stub)

Placeholder screen for future analytics features.

```
+- Analytics -------------------------------------------------+
|                                                              |
|                                                              |
|          Analytics features coming in v0.3                   |
|                                                              |
|          Planned:                                            |
|            - Spending trends over time                       |
|            - Category comparison                             |
|            - Monthly/weekly breakdowns                       |
|            - Budget tracking                                 |
|                                                              |
|                                                              |
+--------------------------------------------------------------+
```

### Screen 4: Settings

Central management for categories, imports, rules, and database operations.

**Layout** (vertical sections, navigate with j/k between sections, Enter to expand):

```
+- Settings --------------------------------------------------+
|                                                              |
|  [1] Categories                                              |
|  ----------------------------------------------------------  |
|  Manage categories: add, edit, delete                        |
|                                                              |
|  [2] Category Rules                                          |
|  ----------------------------------------------------------  |
|  Auto-categorization rules (substring match)                 |
|                                                              |
|  [3] Import                                                  |
|  ----------------------------------------------------------  |
|  Import CSV files, view import history                       |
|                                                              |
|  [4] Database                                                |
|  ----------------------------------------------------------  |
|  Clear database, export data                                 |
|                                                              |
+--------------------------------------------------------------+
```

**Settings > Categories:**

- List all categories with their assigned color
- `a` to add new category (name + color picker from Catppuccin accents)
- `e` to edit selected category
- `d` to delete (two-key confirm: press `d`, then `d` again within 2 seconds)
- Cannot delete "Uncategorised" (default fallback)

**Settings > Category Rules:**

- List rules as: `"pattern" -> Category Name`
- `a` to add: text input for substring, then category picker
- `e` to edit selected rule
- `d` to delete (two-key confirm)
- Rules are evaluated in order (first match wins)
- Rules are applied automatically on import and can be re-applied to existing transactions

**Settings > Import:**

- File picker showing `*.csv` files in CWD
- Format selector (shows configured formats from TOML)
- Import preview: show first 5 rows before committing
- Duplicate detection: warn on rows matching (date + amount + description)
- Import history table: filename, date imported, row count

**Settings > Database:**

- **Clear all data**: Two-key confirm (`c`, then `c` again)
- **Export to CSV**: Export all transactions to a CSV file
- **Database info**: Show row count, file size, schema version

---

## Data Model

### Database Schema (v2)

```sql
-- Schema version tracking
CREATE TABLE IF NOT EXISTS schema_meta (
    version INTEGER NOT NULL
);

-- Categories
CREATE TABLE IF NOT EXISTS categories (
    id          INTEGER PRIMARY KEY AUTOINCREMENT,
    name        TEXT NOT NULL UNIQUE,
    color       TEXT NOT NULL,            -- hex color, e.g. "#a6e3a1"
    sort_order  INTEGER NOT NULL DEFAULT 0,
    is_default  INTEGER NOT NULL DEFAULT 0  -- 1 for "Uncategorised"
);

-- Category rules (auto-categorization)
CREATE TABLE IF NOT EXISTS category_rules (
    id            INTEGER PRIMARY KEY AUTOINCREMENT,
    pattern       TEXT NOT NULL,           -- substring to match in description
    category_id   INTEGER NOT NULL REFERENCES categories(id) ON DELETE CASCADE,
    priority      INTEGER NOT NULL DEFAULT 0,  -- higher = evaluated first
    UNIQUE(pattern)
);

-- Transactions (evolved from v1)
CREATE TABLE IF NOT EXISTS transactions (
    id            INTEGER PRIMARY KEY AUTOINCREMENT,
    date_raw      TEXT NOT NULL,
    date_iso      TEXT NOT NULL,
    amount        REAL NOT NULL,
    description   TEXT NOT NULL,
    category_id   INTEGER REFERENCES categories(id) ON DELETE SET NULL,
    notes         TEXT NOT NULL DEFAULT '',
    import_id     INTEGER REFERENCES imports(id),
    created_at    TEXT NOT NULL DEFAULT (datetime('now'))
);

-- Import history
CREATE TABLE IF NOT EXISTS imports (
    id            INTEGER PRIMARY KEY AUTOINCREMENT,
    filename      TEXT NOT NULL,
    row_count     INTEGER NOT NULL,
    imported_at   TEXT NOT NULL DEFAULT (datetime('now'))
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_transactions_date ON transactions(date_iso);
CREATE INDEX IF NOT EXISTS idx_transactions_category ON transactions(category_id);
CREATE INDEX IF NOT EXISTS idx_category_rules_pattern ON category_rules(pattern);
```

### Schema Migration Strategy

Simple version-based approach:

1. Check `schema_meta` table for current version (0 if table doesn't exist = v0.1 schema)
2. If version < target, drop all tables and recreate (acceptable for personal tool)
3. Insert default categories on fresh schema creation
4. Set `schema_meta.version = 2`

### Default Categories (seeded on first run)

| Name | Color | Sort Order | Default |
|------|-------|------------|---------|
| Income | `#a6e3a1` | 1 | 0 |
| Groceries | `#94e2d5` | 2 | 0 |
| Dining & Drinks | `#fab387` | 3 | 0 |
| Transport | `#89b4fa` | 4 | 0 |
| Bills & Utilities | `#cba6f7` | 5 | 0 |
| Entertainment | `#f5c2e7` | 6 | 0 |
| Shopping | `#f2cdcd` | 7 | 0 |
| Health | `#74c7ec` | 8 | 0 |
| Transfers | `#b4befe` | 9 | 0 |
| Uncategorised | `#7f849c` | 10 | 1 |

### In-Memory Domain Types

```go
type transaction struct {
    id          int
    dateRaw     string
    dateISO     string
    amount      float64
    description string
    categoryID  *int     // nullable
    notes       string
    importID    *int     // nullable
}

type category struct {
    id        int
    name      string
    color     string   // hex
    sortOrder int
    isDefault bool
}

type categoryRule struct {
    id         int
    pattern    string
    categoryID int
    priority   int
}

type importRecord struct {
    id         int
    filename   string
    rowCount   int
    importedAt string
}
```

---

## Config-Driven CSV Format System

### Config File Location

`~/.config/jaskmoney/formats.toml` (XDG-compliant)

### Format Definition

```toml
# Default ANZ format (shipped with app, can be overridden)
[[format]]
name = "ANZ"
description = "ANZ Australia bank export"
date_format = "2/01/2006"     # Go time format string
has_header = false
delimiter = ","
columns = { date = 0, amount = 1, description = "2+" }  # "2+" means join cols 2..n
amount_strip = ","             # characters to strip from amount before parsing
encoding = "utf-8"

# Example: adding CBA format
[[format]]
name = "CBA"
description = "Commonwealth Bank Australia"
date_format = "02/01/2006"
has_header = true
delimiter = ","
columns = { date = 0, amount = 1, description = 2 }
amount_strip = ","
encoding = "utf-8"
```

### Column Mapping

- `date`: column index for date field
- `amount`: column index for amount field
- `description`: column index, or `"N+"` to join columns N through end
- `amount_strip`: characters to remove from amount string before parsing (e.g., commas, dollar signs)

### Behavior

1. On startup, load formats from TOML file. If file doesn't exist, create with ANZ default.
2. Import flow shows format selector before file picker.
3. Format definitions are read-only at runtime (edit the TOML file to add formats).

---

## Interaction Patterns

### Key Bindings (Global)

| Key | Action |
|-----|--------|
| `Tab` | Next tab |
| `Shift+Tab` | Previous tab |
| `q` / `Ctrl+C` | Quit |
| `?` | Toggle help overlay |

### Key Bindings (Dashboard)

| Key | Action |
|-----|--------|
| `j` / `Down` | Scroll dashboard sections |
| `k` / `Up` | Scroll dashboard sections |

### Key Bindings (Transactions)

| Key | Action |
|-----|--------|
| `j` / `Down` | Move cursor down |
| `k` / `Up` | Move cursor up |
| `g` | Go to first row |
| `G` | Go to last row |
| `/` | Activate search input |
| `s` | Cycle sort column |
| `S` | Reverse sort direction |
| `f` | Open category filter |
| `d` | Open date range filter |
| `Enter` | Open transaction detail modal |
| `Esc` | Clear search / close filter / close modal |

### Key Bindings (Settings)

| Key | Action |
|-----|--------|
| `j` / `Down` | Move between sections / items |
| `k` / `Up` | Move between sections / items |
| `Enter` | Expand section / edit item |
| `a` | Add new item (category, rule) |
| `e` | Edit selected item |
| `d` | Delete (first press arms, second press confirms within 2s) |
| `Esc` | Collapse section / cancel edit |

### Two-Key Confirm Pattern

For destructive operations:

1. User presses `d` (or `c` for clear)
2. Status bar shows: `"Press d again to confirm delete"` (text in Yellow)
3. A 2-second timer starts
4. If user presses `d` again within 2s: execute delete
5. If timer expires or any other key pressed: cancel, status bar returns to normal

---

## Duplicate Detection

### Detection Criteria

A transaction is considered a potential duplicate if ALL of the following match an existing row:

- `date_iso` matches exactly
- `amount` matches exactly
- `description` matches exactly (case-insensitive)

### Behavior

1. During import, after parsing each row, check for duplicates
2. Collect all duplicate rows separately
3. After parsing complete, show summary: `"Found 5 potential duplicates out of 113 rows"`
4. Present choice: `"Import all (a) / Skip duplicates (s) / Cancel (c)"`
5. Status bar shows final result: `"Imported 108 rows (5 duplicates skipped) from ANZ.csv"`

---

## New Dependencies

### asciigraph

```
go get github.com/guptarohit/asciigraph@latest
```

- Used for the monthly trend chart on the Dashboard
- `asciigraph.PlotMany` with two series (income, expenses)
- Configure with `asciigraph.Height()`, `asciigraph.Width()` to fit available terminal space
- Use custom ANSI color codes matching Catppuccin Green/Red for series colors

### TOML Parser

```
go get github.com/BurntSushi/toml@latest
```

- For parsing the CSV format config file
- Lightweight, well-established Go TOML library

---

## Phased Implementation Plan

### Phase 1: Foundation & Theme (Estimated: 2-3 days)

**Goal:** New theme, multi-tab navigation, evolved schema — no new features yet.

**Tasks:**

1. **Define Catppuccin Mocha color constants** in a new `theme.go` file
   - All hex values as `lipgloss.Color` constants
   - Semantic aliases (e.g., `colorSuccess`, `colorError`, `colorAccent`)

2. **Restyle all existing render functions** in `render.go`
   - Replace all current style definitions with Catppuccin Mocha styles
   - Replace `boldKey()` raw ANSI with lipgloss styles
   - Update header, footer, status bar, section borders, table rendering

3. **Implement tab navigation** in `model.go`
   - Add `activeTab int` field to model
   - Add `Tab`/`Shift+Tab` key handling
   - Render tab bar in header (active tab highlighted with Lavender)
   - `View()` dispatches to `dashboardView()`, `transactionsView()`, `analyticsView()`, `settingsView()`

4. **Evolve database schema** in `db.go`
   - Add `schema_meta`, `categories`, `category_rules`, `imports` tables
   - Add `category_id`, `notes`, `import_id`, `created_at` to transactions
   - Implement migration: detect v1 schema, recreate as v2, seed default categories
   - Add new query functions: `loadCategories`, `loadRules`, `loadImports`

5. **Update domain types** in `model.go`
   - Add `category`, `categoryRule`, `importRecord` types
   - Add `categories`, `rules`, `imports` fields to model

**Acceptance Criteria:**
- [ ] App launches with Catppuccin Mocha theme applied to all elements
- [ ] Tab bar renders in header with 4 tabs
- [ ] Tab/Shift+Tab cycles between tabs
- [ ] Active tab is visually distinct (Lavender highlight)
- [ ] Footer key hints update per-tab
- [ ] Database auto-migrates from v1 to v2 schema
- [ ] Default 10 categories are seeded on fresh DB
- [ ] Existing transactions are preserved during migration (category_id = NULL)
- [ ] All existing functionality still works (import, view, scroll)

**Tests (Phase 1):**
- `theme_test.go`: Verify all color constants are valid hex
- `db_test.go`: Test schema creation, migration from v1, default category seeding, CRUD for categories/rules/imports
- `render_test.go`: Test `renderHeader` output contains tab labels, active tab styling
- `model_test.go`: Test tab cycling logic (Tab wraps around, Shift+Tab wraps backward)

---

### Phase 2: Transactions Screen (Estimated: 3-4 days)

**Goal:** Full-featured transaction list with search, sort, filter, and category editing.

**Tasks:**

1. **Refactor transaction table rendering**
   - Add category column with color-coded tag/badge
   - Display `date_iso` instead of `date_raw` (ISO format is more readable)
   - Improve column width calculation for 4-column layout
   - Add scroll position indicator ("showing 1-25 of 113")

2. **Implement search** (`/` key)
   - Add `searchMode bool`, `searchQuery string`, `searchInput textinput.Model` to model
   - Filter displayed rows by substring match on description (case-insensitive)
   - Show search bar at top of transaction list when active
   - `Esc` clears search and exits search mode

3. **Implement sorting** (`s` / `S` keys)
   - Add `sortColumn int`, `sortAscending bool` to model
   - Sort columns: date (default), amount, category name, description
   - Display sort indicator in column header (e.g., `Date v`)
   - `s` cycles column, `S` reverses direction

4. **Implement category filter** (`f` key)
   - Popup list of categories with checkboxes
   - Toggle categories on/off
   - Filter transaction list to show only selected categories
   - Show active filter count in header ("Transactions (45/113)")

5. **Implement date range filter** (`d` key)
   - Popup with preset options: This Month, Last Month, Last 3 Months, Last 6 Months, All Time
   - Filter by date_iso range

6. **Implement transaction detail modal** (`Enter` key)
   - Display all transaction fields
   - Category dropdown (navigate with j/k, Enter to select)
   - Notes text input
   - Save updates to DB
   - Apply category rules to uncategorised transactions on save

7. **Add `g`/`G` for jump to first/last row**

**Acceptance Criteria:**
- [ ] Transaction table shows Date, Amount, Category (color-coded), Description columns
- [ ] Amounts show green for positive, red for negative
- [ ] Category displays as a colored tag using the category's assigned color
- [ ] Uncategorised transactions show "Uncategorised" in Overlay 1 color
- [ ] `/` activates search bar, typing filters rows in real-time
- [ ] `Esc` during search clears query and deactivates search mode
- [ ] `s` cycles sort through date -> amount -> category -> description
- [ ] `S` reverses current sort direction
- [ ] Sort direction indicator shows in column header
- [ ] `f` opens category filter popup, categories can be toggled
- [ ] `d` opens date range filter with preset options
- [ ] `Enter` opens detail modal with category dropdown and notes input
- [ ] Category changes save to DB immediately
- [ ] Notes save to DB immediately
- [ ] Scroll indicator shows current position (e.g., "1-25 of 113")
- [ ] `g` jumps to first row, `G` jumps to last row
- [ ] All filters compose (search + category + date range all apply simultaneously)

**Tests (Phase 2):**
- `render_test.go`: Test `renderTable` with category column, color coding, sort indicators
- `model_test.go`:
  - Test search filtering logic (case-insensitive substring match)
  - Test sort behavior (each column, ascending/descending)
  - Test category filter (include/exclude)
  - Test date range filter (boundary conditions)
  - Test filter composition (multiple active filters)
  - Test cursor navigation with `g`/`G`
- `db_test.go`:
  - Test `updateTransactionCategory` query
  - Test `updateTransactionNotes` query
  - Test loading transactions with category joins

---

### Phase 3: Dashboard Widgets & Charts (Estimated: 2-3 days)

**Goal:** Rich dashboard with summary cards, category breakdown, and trend chart.

**Tasks:**

1. **Summary cards widget**
   - Compute: balance, total income, total expenses, transaction count, active category count, date range
   - Render as a compact 2-row, 3-column grid
   - Use Peach for numbers, Subtext 0 for labels

2. **Spending by category widget**
   - Aggregate expenses by category
   - Render horizontal bar chart using Unicode block characters (filled and empty blocks)
   - Each bar uses the category's assigned color
   - Show top 6 categories + "Other" bucket
   - Show percentage and dollar amount per bar

3. **Monthly trend chart**
   - Aggregate income and expenses by month
   - Use `asciigraph.PlotMany` with 2 series
   - Green series = monthly income, Red series = monthly expenses
   - Default window: last 3 months
   - Auto-size to available terminal width

4. **Dashboard scroll** if content exceeds terminal height

**Acceptance Criteria:**
- [ ] Dashboard shows 3 widgets: Summary, Category Breakdown, Monthly Trend
- [ ] Summary cards show Balance, Income, Expenses, Transaction Count, Category Count, Date Range
- [ ] Numbers are formatted with dollar signs and commas (e.g., "$1,234.56")
- [ ] Category breakdown shows horizontal bars with correct proportions
- [ ] Bars use the assigned category colors
- [ ] "Other" bucket aggregates categories beyond top 6
- [ ] Monthly trend renders an asciigraph chart with income (green) and expenses (red) series
- [ ] Chart auto-sizes to terminal width
- [ ] Default time window is last 3 months
- [ ] Dashboard scrolls if content exceeds terminal height
- [ ] Dashboard updates live when switching tabs after data changes

**Tests (Phase 3):**
- `render_test.go`:
  - Test `renderSummaryCards` computes correct values from test data
  - Test `renderCategoryBreakdown` calculates correct percentages
  - Test `renderCategoryBreakdown` limits to top 6 + Other
  - Test bar width proportions
- `model_test.go`:
  - Test monthly aggregation logic (income/expenses per month)
  - Test date range windowing (last 3 months boundary)

---

### Phase 4: Settings Screen & Import Overhaul (Estimated: 3-4 days)

**Goal:** Full settings management, config-driven import, duplicate detection, category rules.

**Tasks:**

1. **Settings screen framework**
   - Collapsible sections (Categories, Rules, Import, Database)
   - Section navigation with j/k, Enter to expand/collapse

2. **Category management UI**
   - List categories with color preview
   - Add: text input for name + color picker (list of Catppuccin accents)
   - Edit: modify name and/or color
   - Delete: two-key confirm, prevent deleting "Uncategorised"

3. **Category rules UI**
   - List rules: `"pattern" -> Category Name`
   - Add: text input for pattern, then category picker
   - Edit/Delete with same patterns
   - "Apply rules to all" action: re-run rules on all uncategorised transactions

4. **TOML format config**
   - Create `~/.config/jaskmoney/formats.toml` with ANZ default if missing
   - Parse format definitions on startup
   - Show format picker in import flow

5. **Import flow overhaul**
   - Move import from popup modal to Settings > Import section
   - Step 1: Select format
   - Step 2: Select file
   - Step 3: Preview first 5 rows
   - Step 4: Duplicate detection report
   - Step 5: Choose action (import all / skip duplicates / cancel)
   - Step 6: Auto-apply category rules to newly imported rows
   - Record import in `imports` table

6. **Import history display**
   - Show past imports: filename, date, row count

7. **Database operations**
   - Clear all data (two-key confirm)
   - Export to CSV (all transactions with category names)
   - Show DB info (row count, file size, schema version)

**Acceptance Criteria:**
- [ ] Settings screen shows 4 collapsible sections
- [ ] Sections expand/collapse with Enter
- [ ] Categories can be added with name + color
- [ ] Categories can be edited (name and color)
- [ ] Category deletion requires `d` pressed twice within 2 seconds
- [ ] Cannot delete the "Uncategorised" category
- [ ] Rules can be added as substring -> category mappings
- [ ] Rules are listed showing pattern and target category
- [ ] "Apply rules to all" processes all uncategorised transactions
- [ ] Import reads format definitions from TOML config file
- [ ] TOML file is auto-created with ANZ default if missing
- [ ] Import flow shows format selection, file picker, preview, duplicate report
- [ ] Duplicate detection correctly identifies matching (date, amount, description)
- [ ] User can choose: import all, skip duplicates, or cancel
- [ ] Category rules auto-apply to newly imported transactions
- [ ] Import history shows filename, date, and row count
- [ ] Clear database requires two-key confirm
- [ ] Export generates a valid CSV file with category names
- [ ] DB info displays row count and schema version

**Tests (Phase 4):**
- `ingest_test.go`:
  - Test CSV parsing with ANZ format
  - Test CSV parsing with custom format (CBA-like)
  - Test duplicate detection (exact match, case-insensitive description)
  - Test partial duplicates (different amounts same date/description -- not duplicate)
  - Test malformed CSV rows (missing columns, bad dates, bad amounts)
  - Test category rule application on import
- `db_test.go`:
  - Test category CRUD (add, edit, delete, prevent default deletion)
  - Test rule CRUD (add, edit, delete, uniqueness)
  - Test import record creation
  - Test "apply rules to all" updates correct transactions
  - Test export query returns all transactions with category names
- `config_test.go`:
  - Test TOML parsing with valid format definitions
  - Test TOML parsing with missing/malformed file
  - Test default config creation
  - Test format field validation

---

### Phase 5: Polish & Edge Cases (Estimated: 1-2 days)

**Goal:** Refinement, edge case handling, final testing pass.

**Tasks:**

1. **Responsive layout testing**
   - Test at various terminal sizes (80x24 minimum, up to 200x60)
   - Ensure all screens degrade gracefully on small terminals
   - Add minimum terminal size warning if below 80x24

2. **Empty state handling**
   - Dashboard with no data: "No transactions yet. Go to Settings > Import to get started."
   - Transactions with no results after filter: "No transactions match your filters."
   - Categories with no custom categories: Show defaults only

3. **Error handling polish**
   - All DB errors show in status bar with Red color
   - Import errors show file name and line number
   - Config file errors show helpful message

4. **Performance check**
   - Test with 10,000+ transactions
   - Ensure scroll is smooth
   - Ensure filters apply without visible lag

5. **Clean up old code**
   - Remove the popup-based import flow (replaced by Settings)
   - Remove `showPopup`, `fileList`, `listReady`, `modalKeys` from model
   - Remove unused message types

6. **Update AGENTS.md** with new file responsibilities

**Acceptance Criteria:**
- [ ] App renders correctly at 80x24 terminal size
- [ ] All screens show appropriate empty states when no data exists
- [ ] Error messages are displayed in Red with context
- [ ] App handles 10,000+ transactions without perceptible lag in scrolling or filtering
- [ ] No dead code from v0.1 popup system remains
- [ ] AGENTS.md updated with new files and responsibilities

**Tests (Phase 5):**
- `render_test.go`: Test empty state rendering for each screen
- `model_test.go`:
  - Test minimum terminal size detection
  - Test responsive layout calculations at boundary sizes
- Integration test: Full cycle test (create DB -> import CSV -> categorize -> filter -> export)

---

## Test-Driven Development Approach

### Test File Structure

| Source File | Test File | Test Focus |
|------------|-----------|------------|
| `theme.go` | `theme_test.go` | Color constant validity |
| `db.go` | `db_test.go` | Schema, migrations, all queries, CRUD |
| `ingest.go` | `ingest_test.go` | CSV parsing, format handling, duplicates |
| `render.go` | `render_test.go` | Visual output correctness, string assertions |
| `model.go` | `model_test.go` | State transitions, navigation, filter logic |
| `overlay.go` | `overlay_test.go` | String utilities (existing functions) |
| `config.go` | `config_test.go` | TOML parsing, defaults, validation |

### Testing Conventions

- **Table-driven tests** with descriptive names: `TestSearchFilter/case_insensitive_match`
- **Test databases** use temporary files: `os.CreateTemp("", "jaskmoney-test-*.db")`
- **Test CSV files** use `os.CreateTemp` with known content
- **Render tests** assert on substrings present in output (e.g., `strings.Contains(output, "Groceries")`)
- **No external dependencies** for tests (no test frameworks beyond `testing`)
- **Deterministic**: No time-dependent tests. Pass time as parameter where needed.

### Test Writing Cadence

Tests are written alongside implementation (not strictly before), but each PR/commit must include:

1. Tests for all new query functions
2. Tests for all new rendering functions
3. Tests for state transition logic (key handling, filter application)
4. Tests for edge cases (empty data, max values, boundary conditions)

### Minimum Coverage Targets

| Package/Area | Target |
|-------------|--------|
| `db.go` (queries) | 90%+ |
| `ingest.go` (parsing) | 95%+ |
| `render.go` (output) | 80%+ |
| `config.go` (TOML) | 90%+ |
| `model.go` (logic) | 70%+ (UI state is harder to test) |
| `overlay.go` (utils) | 95%+ |

---

## File Structure (Post v0.2)

```
jaskmoney/
├── main.go              # Entry point
├── model.go             # Bubble Tea model, messages, Init/Update/View, key handling
├── db.go                # SQLite schema, migrations, all queries
├── ingest.go            # CSV import pipeline, format parsing
├── render.go            # All visual rendering functions
├── overlay.go           # String/layout utilities
├── theme.go             # NEW: Catppuccin Mocha color constants and style definitions
├── config.go            # NEW: TOML config loading, format definitions
├── theme_test.go        # NEW
├── db_test.go           # NEW
├── ingest_test.go       # NEW
├── render_test.go       # NEW
├── model_test.go        # NEW
├── overlay_test.go      # NEW
├── config_test.go       # NEW
├── go.mod
├── go.sum
├── AGENTS.md
├── v0.2-spec.md         # This document
└── ANZ.csv              # Sample data
```

---

## Dependency Summary

| Package | Version | Purpose | Phase |
|---------|---------|---------|-------|
| `github.com/charmbracelet/bubbletea` | v0.26.6 | TUI framework | Existing |
| `github.com/charmbracelet/bubbles` | v0.18.0 | Pre-built components (list, textinput) | Existing |
| `github.com/charmbracelet/lipgloss` | v0.11.0 | Terminal styling | Existing |
| `github.com/charmbracelet/x/ansi` | v0.10.1 | ANSI string handling | Existing |
| `modernc.org/sqlite` | v1.27.0 | Pure-Go SQLite | Existing |
| `github.com/guptarohit/asciigraph` | latest | ASCII line charts | Phase 3 |
| `github.com/BurntSushi/toml` | latest | TOML config parsing | Phase 4 |

---

## Risk & Mitigation

| Risk | Impact | Mitigation |
|------|--------|-----------|
| Schema migration loses data | High | v0.2 drops and recreates -- acceptable for personal tool. Document this clearly. User should export v0.1 data first if needed. |
| asciigraph output doesn't fit terminal | Medium | Dynamically calculate width/height from terminal dimensions. Fall back to simple text if too narrow (<40 cols). |
| TOML config file permissions/location | Low | Use `os.UserConfigDir()` for XDG compliance. Create dirs with `0755`, files with `0644`. |
| Performance with large datasets | Medium | Use SQL-level filtering/sorting (not in-memory). Add `LIMIT/OFFSET` to queries. Index key columns. |
| Category color conflicts on terminals without true-color | Low | Catppuccin provides ANSI 256 fallbacks. Could add detection, but for personal use true-color is assumed. |

---

## Success Criteria (v0.2 Complete)

1. App launches with full Catppuccin Mocha theme -- no remnants of v0.1 styling
2. Four-tab navigation works fluidly with Tab/Shift+Tab
3. Dashboard shows summary cards, category breakdown chart, and monthly trend
4. Transactions screen supports search, sort by any column, filter by category and date range
5. Transaction detail modal allows category assignment and notes
6. Settings screen manages categories, rules, imports, and DB operations
7. CSV import supports config-driven formats with duplicate detection
8. Category rules auto-apply on import
9. Two-key confirm pattern works for all destructive operations
10. `go test ./...` passes with all tests green
11. `go vet ./...` reports no issues
12. `go build .` succeeds cleanly
13. App handles 10,000+ transactions without perceptible lag
